@page "/AddOrUpdateFormItem"
@using EasyMicroservices.UI.BlazorComponents
@using EasyMicroservices.UI.TemplateGenerator.ViewModels.FormItems;
@using MudBlazor
@using global::TemplateGenerators.GeneratedServices;
@inject AddOrUpdateFormItemViewModel viewModel;
@inject ISnackbar Snackbar

<MudStack>
    <MudPaper Class="pa-4">
        <MudStack Spacing="4">
            <MudTextField @bind-Value="viewModel.Title" Label="@viewModel.GetLanguage("Title")" Variant="Variant.Text"></MudTextField>
            <MudSelect @bind-Value="viewModel.Type" Label="@viewModel.GetLanguage("Type")" OpenIcon="@Icons.Material.Filled.LocalDrink" AdornmentColor="Color.Secondary">
                @foreach (ItemType item in Enum.GetValues<ItemType>())
                {
                    if ((int)item < 6)
                        continue;
                    <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                }
            </MudSelect>
            <MudTextField @bind-Value="viewModel.DefaultValue" Label="@viewModel.GetLanguage("DefaultValue")" Variant="Variant.Text"></MudTextField>
        </MudStack>
    </MudPaper>
    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Save" Color="Color.Info" Disabled="viewModel.IsBusy" OnClick="(arg) => viewModel.SaveCommand.Execute(null)">
        @if (viewModel.IsBusy)
        {
            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
            <MudText Class="ms-2">@viewModel.GetLanguage("Saving")</MudText>
        }
        else
        {
            <MudText>@viewModel.GetLanguage("Save")</MudText>
        }
    </MudButton>
    <MudDataGrid T="FormItemContract" Items="viewModel.FormItems">
        <ToolBarContent>
            <MudStack AlignItems="AlignItems.Center" Row="true" Spacing="5">
                <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="(arg) => ShowAddFormItemItemDialog()" />
                @viewModel.GetLanguage("FormItems")
            </MudStack>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Index" Title="@viewModel.GetLanguage("Index")" />
            <PropertyColumn Property="x => x.Title" Title="@viewModel.GetLanguage("Title")" />
            <PropertyColumn Property="x => x.Type" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="(arg) => ShowUpdateFormItemItemDialog(context.Item)" />
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="(arg) => ShowDeleteDialog(context.Item)" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudStack>
<BaseDialog @ref="addDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Add
        </MudText>
    </TitleContent>
    <DialogContent>
        <AddOrUpdateFormItem @ref="AddOrUpdateFormItemView" />
    </DialogContent>
</BaseDialog>
<BaseDialog @ref="deleteDialog">
    <TitleContent>
        <MudText>
            @viewModel.GetLanguage("DeleteFormItem_Title")
        </MudText>
    </TitleContent>
    <DialogContent>
        @viewModel.GetLanguage("DeleteQuestion_Content")
    </DialogContent>
    <DialogActions>
        @if (!viewModel.IsBusy)
        {
            <MudButton OnClick="() => deleteDialog.CloseDialog()">@viewModel.GetLanguage("Cancel")</MudButton>
        }
        <MudButton Color="Color.Error" Variant="Variant.Filled" Disabled="viewModel.IsBusy" OnClick="()=>DoDelete()">
            @if (viewModel.IsBusy)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">@viewModel.GetLanguage("Deleting")</MudText>
            }
            else
            {
                <MudText>@viewModel.GetLanguage("Delete")</MudText>
            }
        </MudButton>
    </DialogActions>
</BaseDialog>
@code {
    public AddOrUpdateFormItemViewModel ViewModel
    {
        get
        {
            return viewModel;
        }
    }
    BaseDialog addDialog;
    BaseDialog deleteDialog;
    AddOrUpdateFormItem AddOrUpdateFormItemView { get; set; }

    protected override Task OnInitializedAsync()
    {
        viewModel.BindPropertyChanged(StateHasChanged);
        _ = viewModel.LoadConfig();
        StateHasChanged();
        return base.OnInitializedAsync();
    }

    void ShowAddFormItemItemDialog()
    {
        addDialog.ShowDialog(() =>
        {
            AddOrUpdateFormItemView.ViewModel.Clear();
            AddOrUpdateFormItemView.ViewModel.OnSuccess = (contract) =>
            {
                viewModel.FormItems.Add(contract);
                addDialog.CloseDialog();
                Snackbar.Add("ثبت با موفقیت انجام شد.", Severity.Success);
                StateHasChanged();
            };
        });
    }

    void ShowUpdateFormItemItemDialog(FormItemContract formItemContract)
    {
        addDialog.ShowDialog(() =>
        {
            AddOrUpdateFormItemView.ViewModel.Clear();
            AddOrUpdateFormItemView.ViewModel.UpdateFormItemContract = formItemContract;
            AddOrUpdateFormItemView.ViewModel.OnSuccess = (item) =>
            {
                viewModel.FormItems.Remove(formItemContract);
                viewModel.FormItems.Insert(0, item);
                addDialog.CloseDialog();
                Snackbar.Add("ویرایش با موفقیت انجام شد.", Severity.Success);
                StateHasChanged();
            };
        });
    }

    void ShowDeleteDialog(FormItemContract formItemContract)
    {
        viewModel.UpdateFormItemContract = formItemContract;
        deleteDialog.ShowDialog();
    }

    void DoDelete()
    {
        viewModel.OnDelete = (o) =>
        {
            deleteDialog.CloseDialog();
            StateHasChanged();
            Snackbar.Add(viewModel.GetLanguage("DeleteForm_Message"), Severity.Success);
        };
        viewModel.DeleteCommand.Execute(viewModel.UpdateFormItemContract);
    }
}
